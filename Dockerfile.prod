FROM node:12.17.0-alpine AS build

WORKDIR /app

COPY package.json ./

COPY tsconfig.json ./

COPY src ./src

RUN ls -a

RUN npm install
RUN npx prisma generate && npm run build

FROM node:12.17.0-alpine AS production

WORKDIR /app

COPY package.json ./

RUN npm install --only=production
RUN npx prisma generate

COPY --from=0 /app/dist .

RUN npm install pm2 -g

EXPOSE 80

CMD ["pm2-runtime", "index.js"]